# Контрольная сумма прерываний

*Этот пример базируется на [02_interrupts](../02_interrupts/readme.md).*

При реализации технологии "детерминированного воспроизведения" (далее
*воспроизведение*) очень важно добиться того, чтобы в течение воспроизведения
поток выполнения прерывался теми же прерываниями и между теми же шагами.

> **Примечание.**
> Определение "шага" потока выполнения зависит от метода измерения "времени"
> в конкретной реализации технологии воспроизведения.
> Для простоты можно понимать "шаг" как выполнение одной
> инструкции; он численно равен количеству выполненных инструкций.

В данном примере функция `main` содержит условно бесконечный цикл,
считающий итерации.
Обработчики прерываний вычисляют накопительную контрольную сумму по
методу CRC (англ. Cyclic Redundancy Code — циклический избыточный код),
добавляя к ней при каждом своём срабатывании текущее значение счётчика
итераций и число, уникальное для каждого вектора прерывания.
Также `main` выводит на экран текущее значение суммы.
После нескольких прерываний происходит выход из цикла, а обработчики
перестают накапливать сумму.

> **Примечание.**
> Под условно бесконечным циклом здесь понимается бесконечный цикл из
> которого всё-таки возможен выход при условии, не зависящем от тела цикла.
> В данном случае: от обработчиков прерываний.

> **Примечание.**
> Реализация 16-битного алгоритма CRC из данного примера базируется на
> [переводе статьи A painless guide to CRC error detection algorithms.
Ross N. Williams.][CRC]

[CRC]: http://ad-books.narod.ru/asm/articles/crc.pdf

На соответствующее место в  `main` может быть установлена точка останова
по управлению (т.н. *breakpoint*), и прочитана итоговая сумма.
При достаточном количестве прерываний итоговая сумма будет отличаться при
каждом запуске с достаточно большой вероятностью.
Это вызвано тем, что многие прерывания являются **внешними**, а момент
отправки IRQ от периферийного устройства не связан жёстко с текущим шагом
выполнения программы (даже если является следствием выполнения программой
определённых действий).

При корректной реализации воспроизведения сумма всегда должна совпадать
с суммой, полученной при записи.
*Следовательно*, данный пример может использоваться как тест реализации
воспроизведения.
