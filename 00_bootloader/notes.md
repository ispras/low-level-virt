
# Загрузчик

При включении ПК стартует т.н. процесс загрузки, _обычно_ заканчивающийся
появлением рабочего стола ОС.
Процесс загрузки состоит из нескольких этапов.
Первым наблюдаемым этапом _обычно_ является загрузка BIOS
(_что происходит до загрузки BIOS известно только разработчику материнской
платы; и то не факт._).
BIOS ищет на доступных ПЗУ т.н. главную загрузочную запись (MBR)
и передаёт ей управление.

В MBR содержится начальная часть т.н. загрузчика.
Загрузчик — это программа, целью которой является, _неожиданно_, загрузка ОС.
Т.к. MBR ограничена размером сектора (512 байт) за вычетом сигнатуры
(2 байта), загрузчик сначала загружает остальную часть себя, а затем уже ОС.
_Примеры загрузчиков: GRUB (для ОС Linux), NTLDR (для ОС Windows)._

## Главная загрузочная запись

[Master Boot Record][MBR] (MBR) — код и данные в первом секторе ОЗУ
с сигнатурой MBR (0xAA55) в последних двух байтах сектора.

[MBR]: https://habr.com/ru/post/347002/

_Фактически, важна только сигнатура, т.к. иначе BIOS не передаст управление._
_Наличие остальных частей MBR (см. ниже) зависит от её предназначения._

### Точка входа

После загрузки сектора в ОЗУ, BIOS устанавливает указатель команд на тот
адрес, куда загружено начало сектора (CS = 0x0000, IP = 0x7C00).
Т.е. начало загрузочной запии является точкой входа в загрузчик (содержит
код, который будет выполнен в первую очередь).

_Согласно исходному коду GRUB, некоторые BIOS могут устанавливать CS = 07C0,
а IP = 0000 вместо 0000:7C00. Это соответствует одному и тому же
физическому адресу, но GRUB навязывает сектор CS = 0000._

### Блок параметров BIOS

[BIOS parameter block][BPB] (BPB) — блок данных, содержимое которого зависит
от файловой системы ПЗУ и ОС
(_причём тут BIOS непонятно, но таково название_).
Он _обычно_ начинается со смещения 0x00B (т.е. под код точки входа доступно
только 11 байт, в которые _обычно_ помещают jmp на адрес после BPB).
Размер BPB зависит от файловой системы, но BPB _обычно_ не выходит за
смещение 0x60.

[BPB]: https://ru.wikipedia.org/wiki/%D0%91%D0%BB%D0%BE%D0%BA_%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%BE%D0%B2_BIOS

_Если нет необходимости загружать какую-то конкретную ОС, то вместо блока
можно поместить произвольные данные или код._

### Произвольные данные

От блока параметров BIOS (если он есть) и до таблицы разделов могут находится
произвольные данные и код загрузчика.
_Дополнительно загрузчик может использовать следующие 62 сектора (между
MBR и первым сектором первого раздела), но их нужно
загрузить с диска явно._

### Таблица разделов

Таблица разделов начинается со смещения 0x1BE и содержит 4 записи размером 16
байт.
Каждая запись соответствует одному разделу.

_Если использование файловой системы не планируется, то и таблица разделов не
обязательна._

### Сигнатура MBR

Если два последних байта (смещение 0x1FE) в конце первого сектора ПЗУ
равны 0x55 и 0xAA
(слово 0xAA55), то BIOS примет содержимое сектора за MBR и передаст управление
на точку входа.
Иначе на мониторе будет написано что-то вроде: "not a bootable disk".

# Источники

[Пишем загрузчик на Ассемблере и C. Часть 1](https://habr.com/ru/company/ruvds/blog/536132/)
