# Защищённый режим (32 бита)

_Согласно документации AMD_, процессор с архитектурой AMD64 имеет следующие
режимы работы:

- унаследованный реальный режим (legacy real mode),
- унаследованный защищённый режим (legacy protected mode),
- унаследованный режим виртуализации 8086 (legacy Virtual-8086 mode),
- длинный режим совместимости (long compatibility mode).
- длинный 64-битный режим (long 64-bit mode).

_Слова "Унаследованный" (legacy) и "длинный" (long) обычно отбрасываются,
когда речь идёт об особенностях, уникальных для конкретного режима, а
когда речь идёт об общих особенностях, используются только эти слова._

После сброса процессор переходит в реальный режим.
Переход в другие режимы ПО должно выполнить самостоятельно.

_Режимы существенно отличаются, но первое (в порядке перехода из
реального режима) отличие заключается в сегментации памяти и доступности
регистров._

## Сегментация памяти

Сегментация памяти _есть ничто иное как_ разбиение физической памяти на
отрезки (сегменты, segments).
Физический адрес (physical address, используемый процессором для обращения
к ОЗУ) вычисляется с использованием эффективного адреса (effective address,
вычисляемый исходя из значения регистра и кодировки инструкции) и
одного из переключателей (выборщика) сегмента (segment selectors, особые
регистры процессора), выбираемого в зависимости от ситуации (выборка
инструкции, доступ к данным и т.д.)
Способ вычисления зависит от режима<!-- работы процессора-->.

### Сегментные регистры

- Пользовательские (переключатели сегментов)...

    - Код: `CS`.
    - Данные: `SS` (стэк), `DS` (по умолчанию для большинства
          обращений к данным), `ES` (строковые инструкции), `FS`, `GS`.

- Системные...
    - Указатели таблиц: `GDTR`, `LDTR`, `IDTR`.
    - Указатель задачи `TR` (Task Register).

### Реальный режим

Вычисления выполняются над 16 битными величинами:

    `base address` = (`*S` `<<` 4);
    `physical address` = `base address` + `effective address`;

Здесь `*S` — число в соответствующем переключателе.

_Очевидно_, доступен только начальный 1MiB физической памяти.

<!--`POP` & `MOV` -> `*S`.-->

### Защищённый режим

Защищённый режим включается битом `CR0.PE` (Protection Enabled, разрешение
защиты, бит 0).
Выполнение кода контролируется таблицами описателей сегментов:

- global-descriptor table (GDT) — глобальная таблица описателей;
- local-descriptor tables (LDT) — локальная таблица описателей;
- interrupt-descriptor table (IDT) — таблица описателей прерываний.

Таблицы состоят из описателей по 8 байт.
В длинных режимах могут _также_ присутствовать описатели по 16 байт.
Выбор из GDT/LDT происходит по переключателю, а из IDT — по номеру вектора
прерывания.
Адрес нулевого описателя и размер таблицы определяется регистрами `GDTR`,
`LDTR`, `IDTR`, соответственно.
Значение регистра `GDTR` загружается из памяти (с помощью инструкции
`LGDT addr`), где имеет следующий формат...

- байты [1:0] (little-endian): ограничитель (limit).
- [10:2]: _виртуальный_ (до трансляции по таблицам страниц) адрес нулевого
    описателя; в унаследованных режимах используются только первые 4 байта.
    <!-- Проверить, что адрес в *DTR виртуальный -->

Формат IDTR в памяти такой же (и зависит от режима).
Загружается инструкцией `LIDT addr`.

Загрузка `LDTR` выполняется инструкцией `LLDT selector` из GDT.
Если `selector` нулевой, то `LDTR` помечается как неверный, а попытки
использовать LDT вызывают `#GP` (кроме инструкций `LAR`, `VERR`, `VERW` и
`LSL`).

_Документация от AMD также содержит описание форматов `GDTR`, `LDTR`, `IDTR`
непосредственно в процессоре._
_При этом выделяется программно-видимая (software visible) и скрытая
(hidden) части._
_Однако, не совсем понятно, как эту информацию можно использовать..._

<!--формулы-->

Вычисления выполняются над 32-битными величинами, что даёт доступ к начальным
4GiB виртуальной _(и физической? см. возможности трансляции страниц)_ памяти.

#### Формат переключателя сегмента

Размер: 16 бит.

- `[2]`: `TI`, Table Indicator, выбор таблицы (0: GDT, 1:LDT).

- `[15:3]`: `SI`, Selector Index, индекс описателя в таблице.
    Размер описателя — 8 байт.
    Если обнулить остальные биты, то получится смещение в таблице.
    Это справедливо и для длинного режима, где есть описатели длиной
    16 байт (повадание в правильное место — это проблема ПО).

- `[1:0]`:
    - `DPL`, descriptor-privilege level (`==` current-privilege level `CPL`,
        когда это `CS`).
    - `RPL`, Requestor Privilege Level, _запрашиваемый?_ уровень
        привелегий.

##### Нулевой переключатель (null selector)

Нулевой переключатель (`SI == 0`, `TI == 0`) в `DS`, `ES`, `FS` и `GS`
приводит к `#GP`, при попытке обращения к данным.
Попытка записать его в `CS` сразу вызывает `#GP`, как и при записи в `SS`
(кроме 64-битного режима при `CPL` < 3).

_См. описание `CPUID Fn8000_0021_EAX[NullSelectorClearsBase]` (бит 6)._

#### Формат описателей сегмента

Формат описателя в памяти зависит от того, что он описывает.
Ниже приводится сводная таблица описателей для защищённого режима.
_Описатели в длинных режимах здесь не рассматриваются._

+-------+--------------------------------------------------------------------------------------+
| Биты  | Описатель сегмента                                                                   |
+-------+--------------------------------------------------------------------------------------+

+-------+---------------------------+----------------------------------------------------------+
|       |  Пользовательский         | Системный                                                |
+-------+---------------------------+----------------------------------------------------------+

+-------+--------------+------------+-----+-----+-----------+-------------------+--------------+
|       | Код          | Данные     | LDT | TSS | Call-Gate | Interrupt-Gate    | Task-Gate    |
|       |              |            |     |     |           | и Trap-Gate       |              |
+-------+--------------+------------+-----+-----+-----------+-------------------+--------------+

+-------+---------------------------------------+-------------------------------+--------------+
| 15:0  | Limit [15:0]                          | Target Code Segment           | Reserved     |
|       |                                       | Offset [15:0]                 |              |
+-------+---------------------------------------+-------------------------------+--------------+

+-------+---------------------------------------+-------------------------------+--------------+
| 31:16 | Base Address [15:0]                   | Target Code Segment Selector  | TSS Selector |
+-------+---------------------------------------+-------------------------------+--------------+


+-------+---------------------------------------+-----------+----------------------------------+
| 36:32 | Base Address [20:16]                  | Parameter | Reserved                         |
|       |                                       | Count     |                                  |
| 4:0   |                                       |           |                                  |
+-------+---------------------------------------+-----------+----------------------------------+

+-------+---------------------------------------+----------------------------------------------+
| 39:37 | Base Address [23:21]                  | Reserved                                     |
|       |                                       |                                              |
| 7:5   |                                       |                                              |
+-------+---------------------------------------+----------------------------------------------+

+-------+---------------------------+----------------------------------------------------------+
| 40    | A                         | Type [0]                                                 |
|       | (Accessed)                |                                                          |
| 8     |                           |                                                          |
+-------+---------------------------+----------------------------------------------------------+

+-------+--------------+------------+----------------------------------------------------------+
| 41    | R            | W          | Type [1]                                                 |
|       | (Readable)   | (Writable) |                                                          |
| 9     |              |            |                                                          |
+-------+--------------+------------+----------------------------------------------------------+

+-------+--------------+------------+----------------------------------------------------------+
| 42    | C            | E          | Type [2]                                                 |
|       | (Conforming) | (Expand-   |                                                          |
| 10    |              |  Down)     |                                                          |
+-------+--------------+------------+----------------------------------------------------------+

+-------+--------------+------------+----------------------------------------------------------+
| 43    | 1            | 0          | Type [3]                                                 |
|       | {= Code}     | {= Data}   |                                                          |
| 11    |              |            |                                                          |
+-------+--------------+------------+----------------------------------------------------------+

+-------+---------------------------+----------------------------------------------------------+
| 44    | S                         | S                                                        |
|       | (System)                  | (System)                                                 |
| 12    | {1 = Пользовательский}    | {0 = Системный}                                          |
+-------+---------------------------+----------------------------------------------------------+

+-------+--------------------------------------------------------------------------------------+
| 46:45 | DPL                                                                                  |
|       |                                                                                      |
| 14:13 |                                                                                      |
+-------+--------------------------------------------------------------------------------------+

+-------+--------------------------------------------------------------------------------------+
| 47    | P                                                                                    |
|       | (Present)                                                                            |
| 15    |                                                                                      |
+-------+--------------------------------------------------------------------------------------+

+-------+---------------------------------------+-------------------------------+--------------+
| 51:48 | Limit [19:16]                         | Target Code Segement          | Reserved     |
|       |                                       | Offset [19:16]                |              |
| 19:16 |                                       |                               |              |
+-------+---------------------------------------+-------------------------------+--------------+

+-------+---------------------------------------+-------------------------------+--------------+
| 52    | AVL                                   | Target Code Segement          | Reserved     |
|       |                                       | Offset [20]                   |              |
| 20    |                                       |                               |              |
+-------+---------------------------------------+-------------------------------+--------------+

+-------+---------------------------------------+-------------------------------+--------------+
| 53    | Reserved                              | Target Code Segement          | Reserved     |
|       |                                       | Offset [21]                   |              |
| 21    |                                       |                               |              |
+-------+---------------------------------------+-------------------------------+--------------+

+-------+---------------------------------------+-------------------------------+--------------+
| 54    | D                                     | Target Code Segement          | Reserved     |
|       | (Default Operand Size)                | Offset [22]                   |              |
| 22    |                                       |                               |              |
+-------+---------------------------------------+-------------------------------+--------------+

+-------+---------------------------------------+-------------------------------+--------------+
| 55    | G                                     | Target Code Segement          | Reserved     |
|       | (Granularity)                         | Offset [23]                   |              |
| 23    |                                       |                               |              |
+-------+---------------------------------------+-------------------------------+--------------+

+-------+---------------------------------------+-------------------------------+--------------+
| 63:56 | Base Address [31:24]                  | Target Code Segement          | Reserved     |
|       |                                       | Offset [31:24]                |              |
| 31:24 |                                       |                               |              |
+-------+---------------------------------------+-------------------------------+--------------+

#### Плоская модель памяти (Flat-Memory Model)

#### Много-сегментная модель памяти (Multi-Segmented Model)

#### Имитация Гарвардской архитектуры

#### Режим виртуализации 8086

- ? optional paging
- ? limited protection checking

### Длинный режим

#### Режим совместимости

compatibility mode ssegmentation == legacy mode ssegmentation (real / protedted)

< 4GiB

#### 64-битный режим

Сегментация _почти_ полностью отключена.
Начальный адрес (base address) считается 0.
Ограничитель (limit) и атрибуты игнорируются (вместо этого требуется
канонический адрес).

Исключения:

- `CS`: `DPL`, `D` (default operation size), `L` (long) атрибуты;
- `FS`, `GS`: могут иметь не нулевой начальный адрес (base address),
    расширенный до 64 бит;
    могут использоваться для TLS (i.e. thread-local data).

Вход/выход и/из длинного режима и работа в нём (в т.ч. переключение между
64-битным режимом и режимом совместимости) не меняет ни видимую, ни
скрытую часть сегментных регистров, за исключением явных загрузок.

#### Регистр задачи и сегмент состояния задачи

- Task Register `TR`
- Task-State Segment `TSS`

## 21-я адресная линия A20

# Источники

[A20 Line. OSDev]: https://wiki.osdev.org/A20_Line
[A20 - a pain from the past]: https://www.win.tue.nl/~aeb/linux/kbd/A20.html
